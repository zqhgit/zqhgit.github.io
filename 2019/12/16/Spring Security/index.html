<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">

  <!-- PACE Progress Bar START -->
  
    <script src="/js/pace.min.js"></script>
    <link rel="stylesheet" href="https://github.com/HubSpot/pace/raw/master/themes/orange/pace-theme-flash.css">
  
  

  <!-- PACE Progress Bar START -->

  
  <title>Sprider</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta name="description" content="Spring Security一. 简介Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。它提供了一组可以在Spring应用上下文中配置的Bean，充分利用了Spring IoC，DI（控制反转Inversion of Control ,DI:Dependency Injection 依赖注入）和AOP（面向切面编程）功能，为应用系">
<meta property="og:type" content="article">
<meta property="og:title" content="Sprider">
<meta property="og:url" content="http://yoursite.com/2019/12/16/Spring Security/index.html">
<meta property="og:site_name" content="Sprider">
<meta property="og:description" content="Spring Security一. 简介Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。它提供了一组可以在Spring应用上下文中配置的Bean，充分利用了Spring IoC，DI（控制反转Inversion of Control ,DI:Dependency Injection 依赖注入）和AOP（面向切面编程）功能，为应用系">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/1.png">
<meta property="og:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/9.png">
<meta property="og:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/2.png">
<meta property="og:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/3.png">
<meta property="og:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/4.png">
<meta property="og:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/5.png">
<meta property="og:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/10.png">
<meta property="og:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/11.png">
<meta property="og:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/12.png">
<meta property="og:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/13.png">
<meta property="og:updated_time" content="2019-12-16T09:08:46.595Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sprider">
<meta name="twitter:description" content="Spring Security一. 简介Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。它提供了一组可以在Spring应用上下文中配置的Bean，充分利用了Spring IoC，DI（控制反转Inversion of Control ,DI:Dependency Injection 依赖注入）和AOP（面向切面编程）功能，为应用系">
<meta name="twitter:image" content="http://yoursite.com/2019/12/16/Spring%20Security/images/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Sprider" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/my.css">
  <!-- Google Adsense -->
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-0123456789ABCDEF",
          enable_page_level_ads: true
      });
  </script>
</head>

<script>
var themeMenus = {};

  themeMenus["/"] = "首页"; 

  themeMenus["/archives"] = "归档"; 

  themeMenus["/categories"] = "分类"; 

  themeMenus["/tags"] = "标签"; 

  themeMenus["/about"] = "关于"; 

</script>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="Sprider" rel="home"> Sprider </a>
            
          </h1>

          
            <div class="site-description">zqh&#39;s internet</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">归档</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">分类</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tags">标签</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>


  <div id="originBgDiv" style="background: #fff; width: 100%;">

      <div style="max-height:600px; overflow: hidden;  display: flex; display: -webkit-flex; align-items: center;">
        <img id="originBg" width="100%" alt="" src="">
      </div>

  </div>

  <script>
  function setAboutIMG(){
      var imgUrls = "css/images/pose.jpg,https://source.unsplash.com/collection/954550/1920x1080".split(",");
      var random = Math.floor((Math.random() * imgUrls.length ));
      if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
        document.getElementById("originBg").src=imgUrls[random];
      } else {
        document.getElementById("originBg").src='/' + imgUrls[random];
      }
  }
  bgDiv=document.getElementById("originBgDiv");
  if(location.pathname.match('about')){
    setAboutIMG();
    bgDiv.style.display='block';
  }else{
    bgDiv.style.display='none';
  }
  </script>



  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-Spring Security" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
    <div class="article-meta">
      
	Posted on <a href="/2019/12/16/Spring Security/" class="article-date">
	  <time datetime="2019-12-16T09:08:46.578Z" itemprop="datePublished">十二月 16, 2019</time>
	</a>

      
	<span id="busuanzi_container_page_pv">
	  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
	</span>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Spring-Security"><a href="#Spring-Security" class="headerlink" title="Spring Security"></a>Spring Security</h2><h3 id="一-简介"><a href="#一-简介" class="headerlink" title="一. 简介"></a>一. 简介</h3><p>Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。它提供了一组可以在Spring应用上下文中配置的Bean，充分利用了Spring IoC，DI（控制反转Inversion of Control ,DI:Dependency Injection 依赖注入）和AOP（面向切面编程）功能，为应用系统提供声明式的安全访问控制功能，减少了为企业系统安全控制编写大量重复代码的工作。</p>
<a id="more"></a>
<p><strong>什么是ACL和RBAC</strong></p>
<ul>
<li>ACL: Access Control List 访问控制列表<ul>
<li>以前盛行的一种权限设计，它的核心在于用户直接和权限挂钩</li>
<li>优点：简单易用，开发便捷</li>
<li>缺点：用户和权限直接挂钩，导致在授予时的复杂性，比较分散，不便于管理</li>
<li>例子：常见的文件系统权限设计, 直接给用户加权限</li>
</ul>
</li>
<li>RBAC: Role Based Access Control <ul>
<li>基于角色的访问控制系统。权限与角色相关联，用户通过成为适当角色的成员而得到这些角色的权限</li>
<li>优点：简化了用户与权限的管理，通过对用户进行分类，使得角色与权限关联起来</li>
<li>缺点：开发对比ACL相对复杂</li>
<li>例子：基于RBAC模型的权限验证框架与应用 Apache Shiro、spring Security</li>
</ul>
</li>
<li>BAT企业 ACL，一般是对报表系统，阿里的ODPS</li>
</ul>
<h3 id="二-入门案例"><a href="#二-入门案例" class="headerlink" title="二. 入门案例"></a>二. 入门案例</h3><h4 id="2-1-添加依赖"><a href="#2-1-添加依赖" class="headerlink" title="2.1 添加依赖"></a>2.1 添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.social<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-social-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="2-2-请求"><a href="#2-2-请求" class="headerlink" title="2.2 请求"></a>2.2 请求</h4><p>​    我们任意编写一个接口，然后进行访问，会直接跳转到一个登录页面</p>
<p><img src="images/1.png" alt=""></p>
<h3 id="三-自定义用户登录处理"><a href="#三-自定义用户登录处理" class="headerlink" title="三. 自定义用户登录处理"></a>三. 自定义用户登录处理</h3><h4 id="3-1-安全配置"><a href="#3-1-安全配置" class="headerlink" title="3.1 安全配置"></a>3.1 安全配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        http.formLogin()  //采用表单登录</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()  //请求认证</span><br><span class="line">                .anyRequest()  //对于任何请求都需要认证</span><br><span class="line">                .authenticated(); //认证通过了才能访问</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-自定义用户认证"><a href="#3-2-自定义用户认证" class="headerlink" title="3.2 自定义用户认证"></a>3.2 自定义用户认证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class UserAuthentication implements UserDetailsService &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private SysUserRepository sysUserRepository;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        SysUser sysUser = sysUserRepository.findByNickyName(username);</span><br><span class="line"></span><br><span class="line">        if (null == sysUser) &#123;</span><br><span class="line">            return new User(username, null, null);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            return new User(username, sysUser.getPassword(),</span><br><span class="line">                    AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;admin&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    在实际的应用过程中，当我们发起请求的时候，springSecurity处理用户登录的过滤器是UsernamePasswordAuthenticationFilter这个过滤器，而这个过滤器会将用户提交的用户名和密码交由UserDetailsService的实现类来处理。具体的处理流程如下图所示：</p>
<p><img src="images/9.png" alt=""></p>
<h4 id="3-3-密码加密校验"><a href="#3-3-密码加密校验" class="headerlink" title="3.3 密码加密校验"></a>3.3 密码加密校验</h4><p>​    密码的加密校验需要实现PasswordEncoder这个接口，接口中有两个方法，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class CustomizePasswordEncoder implements PasswordEncoder &#123;</span><br><span class="line"></span><br><span class="line">    // 注册的时候使用, 人为的去调用</span><br><span class="line">    @Override</span><br><span class="line">    public String encode(CharSequence rawPassword) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 当在返回UserDetails，会自动的去实现校验</span><br><span class="line">    @Override</span><br><span class="line">    public boolean matches(CharSequence rawPassword, String encodedPassword) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    实际工作中我们可以直接使用spring security中默认的密码处理方式就完全可以满足日常的开发。</p>
<h4 id="3-4-自定义登录页面"><a href="#3-4-自定义登录页面" class="headerlink" title="3.4 自定义登录页面"></a>3.4 自定义登录页面</h4><p>​    spring security中定义的登录页面有可能不满足需求，需要自己来实现一个登录页面，处理的方式为只需要在3.1节方法中 formLogin() 方法的后面加上loginPage()方法即可，如下代码所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">	http.formLogin()  //采用表单登录</span><br><span class="line">	    .loginPage(&quot;/login.html&quot;)</span><br><span class="line">		.and()</span><br><span class="line">		.authorizeRequests()  //请求认证</span><br><span class="line">		.anyRequest()  //对于任何请求都需要认真</span><br><span class="line">		.authenticated(); //认证通过了才能访问</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样配置会发现报如下的错误：</p>
<p><img src="images/2.png" alt=""></p>
<p>​    这个错误是很多的初学者容易犯的一个错误，原因是因为对于任何的页面都需要认证，所以就在这里无限循环下去了。我们需要接着调整代码，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">	http.formLogin()  //采用表单登录</span><br><span class="line">	    .loginPage(&quot;/login.html&quot;)</span><br><span class="line">	    .loginProcessingUrl(&quot;/authentication/form&quot;)  //登录页面提交的地址</span><br><span class="line">		.and()</span><br><span class="line">		.authorizeRequests()  //请求认证</span><br><span class="line">		.antMatchers(&quot;/login.html&quot;).permitAll()  //如果是登录页面直接让其访问</span><br><span class="line">		.anyRequest()  //对于任何请求都需要认真</span><br><span class="line">		.authenticated(); //认证通过了才能访问</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-5-编写自己的登录页面"><a href="#3-5-编写自己的登录页面" class="headerlink" title="3.5 编写自己的登录页面"></a>3.5 编写自己的登录页面</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;/authentication/form&quot; method=&quot;post&quot;&gt;</span><br><span class="line">	Username: &lt;input name=&quot;username&quot;&gt; &lt;br&gt;</span><br><span class="line">	Password: &lt;input name=&quot;password&quot; type=&quot;password&quot;&gt; &lt;br&gt;</span><br><span class="line">	&lt;button&gt;提交&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>当我们实现了自己的登录页面后发现还是无法登录，原因在于我们没有加上csrf(跨站请求伪造)，我们暂时先将其禁用，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">	http.formLogin()  //采用表单登录</span><br><span class="line">	    .loginPage(&quot;/login.html&quot;)</span><br><span class="line">	    .loginProcessingUrl(&quot;/authentication/form&quot;)  //登录页面提交的地址</span><br><span class="line">		.and()</span><br><span class="line">		.authorizeRequests()  //请求认证</span><br><span class="line">		.antMatchers(&quot;/login.html&quot;).permitAll()  //如果是登录页面直接让其访问</span><br><span class="line">		.anyRequest()  //对于任何请求都需要认真</span><br><span class="line">		.authenticated()  //认证通过了才能访问</span><br><span class="line">		.and()</span><br><span class="line">        .csrf().disable();  //关闭跨站请求伪造功能</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四-登录成功与失败处理"><a href="#四-登录成功与失败处理" class="headerlink" title="四. 登录成功与失败处理"></a>四. 登录成功与失败处理</h3><h4 id="4-1-登录成功处理"><a href="#4-1-登录成功处理" class="headerlink" title="4.1 登录成功处理"></a>4.1 登录成功处理</h4><p>​    在spring security中，当我们登录成功后默认是跳转到用户登录之前的请求，这个在当今SPA(Single Page Application)应用流行的今天，肯定是不适用的，我们需要的是异步的请求，返回登录成功的信息。</p>
<p>​    要实现用户登录成功处理，需要实现AuthenticationSuccessHandler这个接口，然后实现接口中的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizeAuthenticationSuccessHanler</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory</span><br><span class="line">            .getLogger(CustomizeAuthenticationSuccessHanler.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该bean是springmvc启动的时候实例化的一个对象，纳入到容器中</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * authentication中包含了用户的各种信息，包括UserDetail信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Authentication authentication)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"登录成功"</span>);</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=utf-8"</span>);</span><br><span class="line">        response.getWriter().write(objectMapper.writeValueAsString(authentication));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-2-登录失败处理"><a href="#4-2-登录失败处理" class="headerlink" title="4.2 登录失败处理"></a>4.2 登录失败处理</h4><p>​    通过上面的演示我们能看到每次登录，还是回到登录页面，在异步请求下这种是无法满足我们的需求的，所以需要自定义登录失败处理。要实现AuthenticationFailureHandler这个接口，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerAuthenticationFailHandler</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">AuthenticationFailureHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory</span><br><span class="line">            .getLogger(CustomerAuthenticationFailHandler.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationFailure</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        AuthenticationException exception)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"登录失败"</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"code"</span>, -<span class="number">1</span>);</span><br><span class="line">        map.put(<span class="string">"msg"</span>, <span class="string">"用户名或密码错误"</span>);</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=utf-8"</span>);</span><br><span class="line">        response.getWriter().write(objectMapper.writeValueAsString(map));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>安全配置代码如下：</p>
<p><img src="images/3.png" alt=""></p>
<h3 id="五-记住我"><a href="#五-记住我" class="headerlink" title="五. 记住我"></a>五. 记住我</h3><h4 id="5-1-基本原理"><a href="#5-1-基本原理" class="headerlink" title="5.1 基本原理"></a>5.1 基本原理</h4><p><img src="images/4.png" alt=""></p>
<p>​    在前端页面的请求参数必须叫<strong>remember-me</strong></p>
<h4 id="5-2-功能实现"><a href="#5-2-功能实现" class="headerlink" title="5.2 功能实现"></a>5.2 功能实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserDetailsService userAuthentication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该Bean的主要作用是，可以用于创建数据表并且，当用户直接访问的时候直接从</span></span><br><span class="line"><span class="comment">// 数据库查询用户信息</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PersistentTokenRepository <span class="title">persistentTokenRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	JdbcTokenRepositoryImpl jdbcTokenRepository</span><br><span class="line">		= <span class="keyword">new</span> JdbcTokenRepositoryImpl();</span><br><span class="line">	jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">	jdbcTokenRepository.setCreateTableOnStartup(<span class="keyword">true</span>);</span><br><span class="line">	<span class="keyword">return</span> jdbcTokenRepository;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-3-安全配置"><a href="#5-3-安全配置" class="headerlink" title="5.3 安全配置"></a>5.3 安全配置</h4><p><img src="images/5.png" alt=""></p>
<h3 id="六-图片验证码"><a href="#六-图片验证码" class="headerlink" title="六. 图片验证码"></a>六. 图片验证码</h3><p>​    在实际的应用过程中，为了防止用户的恶意请求，我们通常都会设置图片验证码功能，而springsecurity并没有提供现有的实现，需要开发人员自行的实现。</p>
<h4 id="6-1-封装验证码类"><a href="#6-1-封装验证码类" class="headerlink" title="6.1 封装验证码类"></a>6.1 封装验证码类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageCode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BufferedImage bufferedImage;</span><br><span class="line">    <span class="comment">// code是随机字母，需要存储在session中</span></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="comment">// 过期时间</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 第三个参数为过期的时间</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageCode</span><span class="params">(BufferedImage bufferedImage, String code, <span class="keyword">int</span> seconds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bufferedImage = bufferedImage;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.expireTime = LocalDateTime.now().plusSeconds(seconds); <span class="comment">//设置过期的时间点</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证码是否过期</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExpire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().isAfter(expireTime);  <span class="comment">//当前时间是否在过期时间之后</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// setters、getters、other constructors</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6-2-请求控制类"><a href="#6-2-请求控制类" class="headerlink" title="6.2 请求控制类"></a>6.2 请求控制类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageCodeController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//操作Session的工具类</span></span><br><span class="line">    <span class="keyword">private</span> SessionStrategy sessionStrategy = <span class="keyword">new</span> HttpSessionSessionStrategy();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//session中存放验证码的key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IMAGE_CODE_SESSION_KEY = <span class="string">"IMAGE_CODE_SESSION_KEY"</span>; </span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/image/code"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createCode</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//生成图片验证码，具体的实现照搬现有的工具类</span></span><br><span class="line">        ImageCode imageCode = generate();  </span><br><span class="line"></span><br><span class="line">        <span class="comment">//将图片验证码存放到session中，</span></span><br><span class="line">        sessionStrategy.setAttribute(<span class="keyword">new</span> ServletWebRequest(request), IMAGE_CODE_SESSION_KEY, imageCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将图片写回到页面</span></span><br><span class="line">        ImageIO.write(imageCode.getBufferedImage(), <span class="string">"JPEG"</span>, response.getOutputStream());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6-3-过滤器的编写"><a href="#6-3-过滤器的编写" class="headerlink" title="6.3 过滤器的编写"></a>6.3 过滤器的编写</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidataCodeFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 所有登录失败都交由该类来处理</span></span><br><span class="line">    <span class="keyword">private</span> CustomerAuthenticationFailHandler customerAuthenticationFailHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCustomerAuthenticationFailHandler</span><span class="params">(CustomerAuthenticationFailHandler customerAuthenticationFailHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.customerAuthenticationFailHandler = customerAuthenticationFailHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SessionStrategy sessionStrategy = <span class="keyword">new</span> HttpSessionSessionStrategy();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">//判断是否为登录，并且请求方式为post</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.equals(<span class="string">"/authentication/form"</span>, request.getRequestURI())</span><br><span class="line">                &amp;&amp; StringUtils.equals(request.getMethod(), <span class="string">"POST"</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                validate(<span class="keyword">new</span> ServletWebRequest(request));  <span class="comment">//校验验证码</span></span><br><span class="line">            &#125;<span class="keyword">catch</span> (AuthenticationException exception) &#123;</span><br><span class="line">                customerAuthenticationFailHandler.onAuthenticationFailure(request, response, exception);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 具体的校验逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(ServletWebRequest request)</span> <span class="keyword">throws</span> ServletRequestBindingException </span>&#123;</span><br><span class="line">        <span class="comment">// 从session中获取验证码信息</span></span><br><span class="line">        ImageCode imageCode = (ImageCode) sessionStrategy.getAttribute(request,</span><br><span class="line">                ImageCodeController.IMAGE_CODE_SESSION_KEY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取请求的参数</span></span><br><span class="line">        String validateCode = ServletRequestUtils.getStringParameter(request.getRequest(), <span class="string">"codeImage"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(validateCode)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateException(<span class="string">"验证码不能为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(imageCode == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateException(<span class="string">"验证码不存在"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(imageCode.isExpire()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateException(<span class="string">"验证码过期"</span>);</span><br><span class="line">            sessionStrategy.removeAttribute(request, 		</span><br><span class="line">        				ImageCodeController.IMAGE_CODE_SESSION_KEY);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!validateCode.equals(imageCode.getCode())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateException(<span class="string">"验证码不正确"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sessionStrategy.removeAttribute(request, 		</span><br><span class="line">        				ImageCodeController.IMAGE_CODE_SESSION_KEY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6-4-登录异常处理"><a href="#6-4-登录异常处理" class="headerlink" title="6.4 登录异常处理"></a>6.4 登录异常处理</h4><p>​    springSecurity中处理用户登录异常都应该由AuthenticationException这个异常来处理，所以我们需要自定义验证码校验失败的异常类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateException</span> <span class="keyword">extends</span> <span class="title">AuthenticationException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ValidateException</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="七-手机号登录"><a href="#七-手机号登录" class="headerlink" title="七. 手机号登录"></a>七. 手机号登录</h3><p>​    手机号登录与用户名密码登录逻辑相同，所以我们在使用手机号登录系统的时候可以完全拷贝用户名密码登录的逻辑，那么前提是我们必须得搞懂用户名密码登录的逻辑。</p>
<h4 id="7-1-编写Token"><a href="#7-1-编写Token" class="headerlink" title="7.1 编写Token"></a>7.1 编写Token</h4><p>​    编写手机号认证Token, 模仿UsernamePasswordAuthenticationToken这个类来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信验证码Token, 用于封装用户使用手机登录的相关信息。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsAuthenticationToken</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationToken</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// principal在未登录之前封装用户的手机号，登录之后封装用户的信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object principal;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ~ Constructors</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This constructor can be safely used by any code that wishes to create a</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;UsernamePasswordAuthenticationToken&lt;/code&gt;, as the &#123;<span class="doctag">@link</span> #isAuthenticated()&#125;</span></span><br><span class="line"><span class="comment">     * will return &lt;code&gt;false&lt;/code&gt;.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SmsAuthenticationToken</span><span class="params">(Object principal)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.principal = principal;</span><br><span class="line">        setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This constructor should only be used by &lt;code&gt;AuthenticationManager&lt;/code&gt; or</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;AuthenticationProvider&lt;/code&gt; implementations that are satisfied with</span></span><br><span class="line"><span class="comment">     * producing a trusted (i.e. &#123;<span class="doctag">@link</span> #isAuthenticated()&#125; = &lt;code&gt;true&lt;/code&gt;)</span></span><br><span class="line"><span class="comment">     * authentication token.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principal</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authorities</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SmsAuthenticationToken</span><span class="params">(Object principal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(authorities);</span><br><span class="line">        <span class="keyword">this</span>.principal = principal;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">true</span>); <span class="comment">// must use super, as we override</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.principal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isAuthenticated) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eraseCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.eraseCredentials();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7-2-编写Filter"><a href="#7-2-编写Filter" class="headerlink" title="7.2 编写Filter"></a>7.2 编写Filter</h4><p>​    手机号的过滤器可以模仿 UsernamePasswordAuthenticationFilter 来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsAuthenticationFilter</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">        <span class="title">AbstractAuthenticationProcessingFilter</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ~ Static fields/initializers</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_SECURITY_FORM_MOBILE_KEY = <span class="string">"mobile"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String mobileParameter = SPRING_SECURITY_FORM_MOBILE_KEY;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> postOnly = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SmsAuthenticationFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="keyword">new</span> AntPathRequestMatcher(<span class="string">"/authentication/mobile"</span>, <span class="string">"POST"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ~ Methods</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (postOnly &amp;&amp; !request.getMethod().equals(<span class="string">"POST"</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(</span><br><span class="line">                    <span class="string">"Authentication method not supported: "</span> + request.getMethod());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String mobile = obtainMobile(request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mobile == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mobile = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mobile = mobile.trim();</span><br><span class="line"></span><br><span class="line">        SmsAuthenticationToken authRequest = <span class="keyword">new</span> SmsAuthenticationToken(mobile);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allow subclasses to set the "details" property</span></span><br><span class="line">        setDetails(request, authRequest);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">obtainMobile</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request.getParameter(mobileParameter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Provided so that subclasses may configure what is put into the authentication</span></span><br><span class="line"><span class="comment">     * request's details property.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request that an authentication request is being created for</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authRequest the authenticatio request object that should have its details</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setDetails</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                              SmsAuthenticationToken authRequest)</span> </span>&#123;</span><br><span class="line">        authRequest.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the parameter name which will be used to obtain the username from the login</span></span><br><span class="line"><span class="comment">     * request.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMobileParameter</span><span class="params">(String mobileParameter)</span> </span>&#123;</span><br><span class="line">        Assert.hasText(mobileParameter, <span class="string">"Mobile parameter must not be empty or null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.mobileParameter = mobileParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPostOnly</span><span class="params">(<span class="keyword">boolean</span> postOnly)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.postOnly = postOnly;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7-3-Provider"><a href="#7-3-Provider" class="headerlink" title="7.3 Provider"></a>7.3 Provider</h4><p>​    Provider的作用是用来处理对应的Token，校验用户名密码使用的Provider为DaoAuthenticationProvider,  在实现我们自己的Provider的时候，我们去实现AuthenticationProvider。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCredentialsProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">getUserDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserDetailsService</span><span class="params">(UserDetailsService userDetailsService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实际传入过来的就是 SmsAuthenticationToken, 因为supports方法已经进行了判断，如果为true,才进入该方法</span></span><br><span class="line">        SmsAuthenticationToken smsAuthenticationToken = (SmsAuthenticationToken)authentication;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用</span></span><br><span class="line">        UserDetails user = userDetailsService.loadUserByUsername((String)smsAuthenticationToken.getPrincipal());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> == user) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalAuthenticationServiceException(<span class="string">"无法获取用户信息"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将用户信息以及用户权限 重新构建一个SmsAuthenticationToken</span></span><br><span class="line">        SmsAuthenticationToken token = <span class="keyword">new</span> SmsAuthenticationToken(user, user.getAuthorities());</span><br><span class="line">        token.setDetails(smsAuthenticationToken.getDetails());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断当前的方法的参数authentication, 是否为SmsAuthenticationToken这个类型，</span></span><br><span class="line"><span class="comment">     * 如果是的化，就调用上面的  authenticate 方法。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authentication</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SmsAuthenticationToken.class.isAssignableFrom(authentication);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7-4-发送短信实现"><a href="#7-4-发送短信实现" class="headerlink" title="7.4 发送短信实现"></a>7.4 发送短信实现</h4><p>接口的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SmsCodeSender</span> </span>&#123;</span><br><span class="line">    <span class="comment">//发送手机短信验证码的</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(String code, String mobile)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSmsCodeSender</span> <span class="keyword">implements</span> <span class="title">SmsCodeSender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String code, String mobile)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"往手机 "</span> + mobile + <span class="string">" 上发送的验证码为: "</span> + code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7-5-配置Filter以及Provider"><a href="#7-5-配置Filter以及Provider" class="headerlink" title="7.5 配置Filter以及Provider"></a>7.5 配置Filter以及Provider</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCodeAuthenticationConfig</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">SecurityConfigurerAdapter</span>&lt;<span class="title">DefaultSecurityFilterChain</span>, <span class="title">HttpSecurity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomizeAuthenticationSuccessHanler customizeAuthenticationSuccessHanler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerAuthenticationFailHandler customerAuthenticationFailHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userAuthentication;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SmsAuthenticationFilter smsAuthenticationFilter = <span class="keyword">new</span> SmsAuthenticationFilter();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置AuthenticationManager, 用于同一管理Filter</span></span><br><span class="line">        smsAuthenticationFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager.class));</span><br><span class="line">        <span class="comment">//设置成功处理器</span></span><br><span class="line">        smsAuthenticationFilter.setAuthenticationSuccessHandler(customizeAuthenticationSuccessHanler);</span><br><span class="line">        <span class="comment">//设置失败过滤器</span></span><br><span class="line">        smsAuthenticationFilter.setAuthenticationFailureHandler(customerAuthenticationFailHandler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化Provider</span></span><br><span class="line">        SmsCredentialsProvider smsCredentialsProvider = <span class="keyword">new</span> SmsCredentialsProvider();</span><br><span class="line">        smsCredentialsProvider.setUserDetailsService(userAuthentication);</span><br><span class="line"></span><br><span class="line">        http.authenticationProvider(smsCredentialsProvider)</span><br><span class="line">                .addFilterAfter(smsAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7-6-安全配置"><a href="#7-6-安全配置" class="headerlink" title="7.6 安全配置"></a>7.6 安全配置</h4><p><img src="images/10.png" alt=""></p>
<p>​    短信验证码的过滤器和图片验证码的逻辑是相同，故在此不作处理。</p>
<h4 id="7-7-页面的实现"><a href="#7-7-页面的实现" class="headerlink" title="7.7 页面的实现"></a>7.7 页面的实现</h4><p><img src="images/11.png" alt=""></p>
<p><img src="images/12.png" alt=""></p>
<h3 id="八-session管理"><a href="#八-session管理" class="headerlink" title="八. session管理"></a>八. session管理</h3><h4 id="8-1-session并发控制"><a href="#8-1-session并发控制" class="headerlink" title="8.1 session并发控制"></a>8.1 session并发控制</h4><p>​    session的失效时间默认为30min，可以通过 server.servlet.session.timeout类配置。在很多的业务场景下，我们只允许一台设备登录到服务端。</p>
<p><strong>安全配置</strong></p>
<p><img src="images/13.png" alt=""></p>
<p><strong>session失效处理逻辑</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同时多设备登录处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultipleSessionHandler</span> <span class="keyword">implements</span> <span class="title">SessionInformationExpiredStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExpiredSessionDetected</span><span class="params">(SessionInformationExpiredEvent event)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletResponse response = event.getResponse();</span><br><span class="line">        response.setContentType(<span class="string">"text/plain;charset=utf-8"</span>);</span><br><span class="line">        response.getWriter().write(<span class="string">"其他设备登录"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8-2-session集群管理"><a href="#8-2-session集群管理" class="headerlink" title="8.2 session集群管理"></a>8.2 session集群管理</h4><p>​    当我们在集群环境下，用户每次的请求我们并不能保证每次都是到达同一台服务器，可能会导致session存在于不同的服务器上，而让用户重新进行登录，所以必须要采用一个中间件来存储用户的session信息，企业中使用最多的就是redis.</p>
<p><strong>依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>applicatoin.yml配置</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  redis:</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">6379</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    password:</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">    lettuce:</span></span><br><span class="line"><span class="attr">      pool:</span></span><br><span class="line"><span class="attr">        min-idle:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">        max-active:</span> <span class="number">8</span></span><br><span class="line"><span class="attr">  session:</span></span><br><span class="line"><span class="attr">    store-type:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>
<h3 id="九-退出登录"><a href="#九-退出登录" class="headerlink" title="九. 退出登录"></a>九. 退出登录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.logout()  //</span><br><span class="line">.logoutSuccessUrl(&quot;/login.html&quot;) //退出后跳转的页面</span><br><span class="line">.and()</span><br></pre></td></tr></table></figure>
<h3 id="十-权限管理"><a href="#十-权限管理" class="headerlink" title="十. 权限管理"></a>十. 权限管理</h3><p>​    权限是大部分的后台管理系统都需要实现的功能，用户控制不同的角色能够进行的不同的操作。Spring Security的可以进行用户的角色权限控制，也可以进行用户的操作权限控制。在之前的代码实现上，我们仅仅只是实现用户的登录，在用户信息验证的时候使用UserDetailsService，但是却一直忽略了用户的权限。</p>
<h4 id="10-1-启动类配置"><a href="#10-1-启动类配置" class="headerlink" title="10.1 启动类配置"></a>10.1 启动类配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开启方法的注解安全校验。</span></span><br><span class="line"><span class="comment"> *  securedEnabled  <span class="doctag">@Secured</span>("ROLE_abc")  该注解是Spring security提供的</span></span><br><span class="line"><span class="comment"> *  jsr250Enabled  <span class="doctag">@RolesAllowed</span>("admin")  该注解是 JSR250 支持的注解形式</span></span><br><span class="line"><span class="comment"> *  prePostEnabled</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(securedEnabled = <span class="keyword">true</span>, jsr250Enabled = <span class="keyword">true</span>, prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SecurityApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10-2-基于角色的权限控制"><a href="#10-2-基于角色的权限控制" class="headerlink" title="10.2 基于角色的权限控制"></a>10.2 基于角色的权限控制</h4><p><strong>用户权限的查询</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSecurityService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 调用形式有两种：</span></span><br><span class="line"><span class="comment">         *   1. 此时构建的 SimpleGrantedAuthority 必须是以 ROLE_ 开头, 例如 ROLE_admin, ROLE_manager.</span></span><br><span class="line"><span class="comment">         *      实现全权限控制的时候使用 <span class="doctag">@RolesAllowed</span>("ROLE_admin")  或者 <span class="doctag">@RolesAllowed</span>("admin") 都可以</span></span><br><span class="line"><span class="comment">         *   2. 此时构建的 SimpleGrantedAuthority 必须是以 ROLE_ 开头, 例如 ROLE_admin, ROLE_manager.</span></span><br><span class="line"><span class="comment">         *     实现全权限控制的时候使用 <span class="doctag">@Secured</span>("ROLE_admin") ROLE_是不能省略的。</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  其中1，2也只能实现对角色的控制，那么如果细粒度到具体的方法进行控制，需要使用到其他的方式。</span></span><br><span class="line"><span class="comment">         *  A. new SimpleGrantedAuthority("user:delete")   <span class="doctag">@PreAuthorize</span>("hasAnyAuthority('user:add', 'user:list')") 无法访问。</span></span><br><span class="line"><span class="comment">         *  B. new SimpleGrantedAuthority("user:add")     <span class="doctag">@PreAuthorize</span>("hasAnyAuthority('user:add', 'user:list')") 可以访问。</span></span><br><span class="line"><span class="comment">         *  C. Arrays.asList(new SimpleGrantedAuthority("user:add"), new SimpleGrantedAuthority("user:list"))</span></span><br><span class="line"><span class="comment">         *     <span class="doctag">@PreAuthorize</span>("hasAuthority('user:add') and hasAuthority('user:list')") 可以访问</span></span><br><span class="line"><span class="comment">         *  D. new SimpleGrantedAuthority("ROLE_admin") 定义角色</span></span><br><span class="line"><span class="comment">         *    <span class="doctag">@PreAuthorize</span>("hasRole('admin')")  可以访问</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username, sysUser.getPassword(),</span><br><span class="line">                Arrays.asList(<span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">"ROLE_admin"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在构建SimpleGrantedAuthority对象的时候，用户的角色必须是以 <code>ROLE_</code> 开头，例如 <code>ROLE_admin</code>、<code>ROLE_manager</code> </p>
<p><strong>控制器角色控制</strong></p>
<p>​    在控制器上进行用户访问控制的时候，基于角色有两种书写方式：</p>
<p>方式一：@RolesAllowed</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">@RolesAllowed</span> 中的值可以写成 "admin", 例如 <span class="doctag">@RolesAllowed</span>("admin")</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">@RolesAllowed</span> 中的值还可以写成 "ROLE_admin"，例如 <span class="doctag">@RolesAllowed</span>("ROLE_admin")</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@RolesAllowed</span>(<span class="string">"admin"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> User(<span class="number">10</span>, <span class="string">"张"</span>), <span class="keyword">new</span> User(<span class="number">20</span>, <span class="string">"李四"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方式二：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">@Secured</span> 中的值必须为 "ROLE_admin"，例如 <span class="doctag">@Secured</span>("ROLE_admin")，ROLE_不能省略</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@Secured</span>(<span class="string">"ROLE_admin"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> User(<span class="number">10</span>, <span class="string">"张"</span>), <span class="keyword">new</span> User(<span class="number">20</span>, <span class="string">"李四"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10-3-基于操作的权限控制"><a href="#10-3-基于操作的权限控制" class="headerlink" title="10.3 基于操作的权限控制"></a>10.3 基于操作的权限控制</h4><p>​    当然我们也可以使用基于操作的权限控制，这个功能稍显得有点累赘，因为在实际的项目开发过程中我们都是基于角色的权限控制。</p>
<p><strong>用户权限查询</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSecurityService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        return new User(username, sysUser.getPassword(),</span></span><br><span class="line"><span class="comment">                Arrays.asList(new SimpleGrantedAuthority("ROLE_admin")));</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username, sysUser.getPassword(),</span><br><span class="line">                Arrays.asList(<span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">"user:list"</span>),</span><br><span class="line">                <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">"user:add"</span>)</span><br><span class="line">                ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>控制器访问控制(针对角色)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">@PreAuthorize</span> 中的值可以为 "ROLE_admin", "admin"，</span></span><br><span class="line"><span class="comment"> *  例如 <span class="doctag">@PreAuthorize</span>("hasRole('admin')") 或者为  </span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@PreAuthorize</span>("hasRole('ROLE_admin')")</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('admin')"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> User(<span class="number">10</span>, <span class="string">"张"</span>), <span class="keyword">new</span> User(<span class="number">20</span>, <span class="string">"李四"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>控制器访问控制(针对操作)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="comment">// @PreAuthorize("hasAuthority('user:add') and hasAuthority('user:list')") </span></span><br><span class="line"><span class="comment">// @PreAuthorize("hasAuthority('user:add') or hasAuthority('user:list')")</span></span><br><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasAnyAuthority('user:add', 'user:list')"</span>) </span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> User(<span class="number">10</span>, <span class="string">"张"</span>), <span class="keyword">new</span> User(<span class="number">20</span>, <span class="string">"李四"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10-4-访问无权限处理"><a href="#10-4-访问无权限处理" class="headerlink" title="10.4 访问无权限处理"></a>10.4 访问无权限处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.and()</span><br><span class="line">.exceptionHandling()</span><br><span class="line">.accessDeniedHandler(customizeAccessDeniedHandler)  <span class="comment">//无权限访问处理</span></span><br><span class="line">.and()</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="entry-meta entry-footer">
      
      
      
        <div id="donation_div"></div>

<script src="/js/vdonate.js"></script>
<script>
var a = new Donate({
  title: '如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!', // 可选参数，打赏标题
  btnText: '打赏支持', // 可选参数，打赏按钮文字
  el: document.getElementById('donation_div'),
  wechatImage: 'https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/site/source/about/donate/images/WeChanQR.png',
  alipayImage: 'https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/site/source/about/donate/images/AliPayQR.jpg'
});
</script>
      
            
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>


      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/06/03/a/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">我的第一篇博客</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
      <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Security"><span class="nav-number">1.</span> <span class="nav-text">Spring Security</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一-简介"><span class="nav-number">1.1.</span> <span class="nav-text">一. 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二-入门案例"><span class="nav-number">1.2.</span> <span class="nav-text">二. 入门案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-添加依赖"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 添加依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-请求"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 请求</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三-自定义用户登录处理"><span class="nav-number">1.3.</span> <span class="nav-text">三. 自定义用户登录处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-安全配置"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 安全配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-自定义用户认证"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 自定义用户认证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-密码加密校验"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.3 密码加密校验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-自定义登录页面"><span class="nav-number">1.3.4.</span> <span class="nav-text">3.4 自定义登录页面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-编写自己的登录页面"><span class="nav-number">1.3.5.</span> <span class="nav-text">3.5 编写自己的登录页面</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四-登录成功与失败处理"><span class="nav-number">1.4.</span> <span class="nav-text">四. 登录成功与失败处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-登录成功处理"><span class="nav-number">1.4.1.</span> <span class="nav-text">4.1 登录成功处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-登录失败处理"><span class="nav-number">1.4.2.</span> <span class="nav-text">4.2 登录失败处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#五-记住我"><span class="nav-number">1.5.</span> <span class="nav-text">五. 记住我</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-基本原理"><span class="nav-number">1.5.1.</span> <span class="nav-text">5.1 基本原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-功能实现"><span class="nav-number">1.5.2.</span> <span class="nav-text">5.2 功能实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-安全配置"><span class="nav-number">1.5.3.</span> <span class="nav-text">5.3 安全配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#六-图片验证码"><span class="nav-number">1.6.</span> <span class="nav-text">六. 图片验证码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-封装验证码类"><span class="nav-number">1.6.1.</span> <span class="nav-text">6.1 封装验证码类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-请求控制类"><span class="nav-number">1.6.2.</span> <span class="nav-text">6.2 请求控制类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-过滤器的编写"><span class="nav-number">1.6.3.</span> <span class="nav-text">6.3 过滤器的编写</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-登录异常处理"><span class="nav-number">1.6.4.</span> <span class="nav-text">6.4 登录异常处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#七-手机号登录"><span class="nav-number">1.7.</span> <span class="nav-text">七. 手机号登录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-编写Token"><span class="nav-number">1.7.1.</span> <span class="nav-text">7.1 编写Token</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-编写Filter"><span class="nav-number">1.7.2.</span> <span class="nav-text">7.2 编写Filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-Provider"><span class="nav-number">1.7.3.</span> <span class="nav-text">7.3 Provider</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-发送短信实现"><span class="nav-number">1.7.4.</span> <span class="nav-text">7.4 发送短信实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-配置Filter以及Provider"><span class="nav-number">1.7.5.</span> <span class="nav-text">7.5 配置Filter以及Provider</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-安全配置"><span class="nav-number">1.7.6.</span> <span class="nav-text">7.6 安全配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-7-页面的实现"><span class="nav-number">1.7.7.</span> <span class="nav-text">7.7 页面的实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#八-session管理"><span class="nav-number">1.8.</span> <span class="nav-text">八. session管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-session并发控制"><span class="nav-number">1.8.1.</span> <span class="nav-text">8.1 session并发控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-session集群管理"><span class="nav-number">1.8.2.</span> <span class="nav-text">8.2 session集群管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#九-退出登录"><span class="nav-number">1.9.</span> <span class="nav-text">九. 退出登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#十-权限管理"><span class="nav-number">1.10.</span> <span class="nav-text">十. 权限管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#10-1-启动类配置"><span class="nav-number">1.10.1.</span> <span class="nav-text">10.1 启动类配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-2-基于角色的权限控制"><span class="nav-number">1.10.2.</span> <span class="nav-text">10.2 基于角色的权限控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-基于操作的权限控制"><span class="nav-number">1.10.3.</span> <span class="nav-text">10.3 基于操作的权限控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-4-访问无权限处理"><span class="nav-number">1.10.4.</span> <span class="nav-text">10.4 访问无权限处理</span></a></li></ol></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 Sprider All Rights Reserved.
          
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var contentdiv = document.getElementById("content");

    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

<!-- Custome JS -->
<script src="/js/my.js"></script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
